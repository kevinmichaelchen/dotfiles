#!/bin/bash
# Manage mcpServers config in ~/.claude.json without touching runtime state
# Uses jq to merge our MCP config into the existing file

set -euo pipefail

# Define the MCP servers configuration
# Uses environment variables for secrets (set via shell/*.sh.tmpl files)
MCP_CONFIG='{
  "mcpServers": {
    "context7": {
      "type": "http",
      "url": "https://mcp.context7.com/mcp",
      "headers": {
        "CONTEXT7_API_KEY": "${CONTEXT7_API_KEY}"
      }
    },
    "deepwiki": {
      "type": "http",
      "url": "https://mcp.deepwiki.com/mcp"
    },
    "effect-docs": {
      "command": "npx",
      "args": ["-y", "effect-mcp@latest"],
      "env": {}
    },
    "grep": {
      "type": "http",
      "url": "https://mcp.grep.app"
    },
    "nx-mcp": {
      "type": "stdio",
      "command": "npx",
      "args": ["nx-mcp@latest"],
      "env": {}
    },
    "perplexity": {
      "command": "perplexity-mcp",
      "args": [],
      "env": {
        "PERPLEXITY_API_KEY": "${PERPLEXITY_API_KEY}"
      },
      "type": "stdio"
    },
    "nia": {
      "command": "pipx",
      "args": ["run", "--no-cache", "nia-mcp-server"],
      "env": {
        "NIA_API_KEY": "${NIA_API_KEY}",
        "NIA_API_URL": "https://apigcp.trynia.ai/"
      },
      "type": "stdio"
    },
{{- if eq .chezmoi.hostname "MLJLWV4J4TLC" }}
    "atlassian": {
      "command": "mcp-atlassian",
      "args": [],
      "env": {
        "JIRA_URL": "${JIRA_URL}",
        "JIRA_USERNAME": "${JIRA_USERNAME}",
        "JIRA_API_TOKEN": "${JIRA_API_TOKEN}",
        "CONFLUENCE_URL": "${CONFLUENCE_URL}",
        "CONFLUENCE_USERNAME": "${CONFLUENCE_USERNAME}",
        "CONFLUENCE_API_TOKEN": "${CONFLUENCE_API_TOKEN}"
      },
      "type": "stdio"
    },
{{- end }}
    "exa": {
      "command": "npx",
      "args": ["-y", "exa-mcp-server"],
      "env": {
        "EXA_API_KEY": "${EXA_API_KEY}"
      },
      "type": "stdio"
    },
    "huggingface": {
      "command": "huggingface-mcp-server",
      "args": [],
      "env": {
        "HF_TOKEN": "${HF_TOKEN}"
      },
      "type": "stdio"
    }
  }
}'

# Read existing file from stdin, replace mcpServers (not merge), preserve other keys
jq --argjson mcp "$MCP_CONFIG" '.mcpServers = $mcp.mcpServers'
